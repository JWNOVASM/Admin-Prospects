function render_prospects_shortcode() {
    if (!current_user_can('administrator') && !current_user_can('account_manager')) {
        return 'You do not have permission to view this page';
    }

    global $wpdb;
    $table_name = $wpdb->prefix . 'prospects';

    // Fetching live prospects
    $prospects_live = $wpdb->get_results("SELECT * FROM $table_name WHERE prospect_status = 'live'");

    // Fetching successful prospects
    $prospects_success = $wpdb->get_results("SELECT * FROM $table_name WHERE prospect_status = 'success'");

    // Fetching lost prospects
    $prospects_lost = $wpdb->get_results("SELECT * FROM $table_name WHERE prospect_status = 'lost'");

    // Enqueue DataTables and jQuery scripts/styles
    wp_enqueue_script('datatables-js', 'https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js', ['jquery'], null, true);
    wp_enqueue_style('datatables-css', 'https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css');

    ob_start();
    ?>
    <div id="prospects-section">
        <h2>Live Prospects</h2>
        <table id="live_prospects" class="display">
            <thead>
				<tr>
					<thead>
					<tr>
						<th>ID</th>
						<th>Name</th>
						<th>Instagram</th>
						<th>Email</th>
						<th>Phone</th>
						<th>Client Type</th>
						<th>Prospect Type</th>
						<th>Status</th>
						<th>Temperature</th>
						<th>Last Updated</th>
						<th>Account Manager</th>
						<th>Success</th>
						<th>Delete</th>
					</tr>
				</thead>
				</tr>
			</thead>
            <tbody>
                <?php foreach ($prospects_live as $prospect) {
                    $account_manager = get_userdata($prospect->account_manager_id);
                    $account_manager_name = $account_manager ? $account_manager->first_name . ' ' . $account_manager->last_name : 'Unassigned';
                    $last_note = $wpdb->get_row($wpdb->prepare("SELECT timestamp FROM {$wpdb->prefix}prospect_notes WHERE prospect_id = %d ORDER BY timestamp DESC LIMIT 1", $prospect->id));
                    $last_updated = $last_note ? $last_note->timestamp : $prospect->last_updated;
                ?>
                <tr>
                    <td class='live_ID'><?php echo esc_html($prospect->id); ?></td>
                    <td class='live_name'><a href="<?php echo site_url('/admin/prospects/profile/?prospect_id=' . $prospect->id); ?>"><?php echo esc_html($prospect->name); ?></a></td>
                    <td class='live_instagram'><?php echo esc_html($prospect->instagram); ?></td>
                    <td class='live_email'><?php echo esc_html($prospect->email); ?></td>
                    <td class='live_phone'><?php echo esc_html($prospect->phone); ?></td>
                    <td class='live_client_type'><?php echo esc_html($prospect->client_type); ?></td>
                    <td class='live_prospect_type'><?php echo esc_html($prospect->prospect_type); ?></td>
                    <td class='live_status'><?php echo esc_html($prospect->status); ?></td>
                    <td class='live_temperature'><?php echo esc_html($prospect->temperature); ?></td>
                    <td class='live_last_updated'><?php echo esc_html($last_updated); ?></td>
                    <td class='live_account_manager'><?php echo esc_html($account_manager_name); ?></td>
                    <td class='live_success'><button class='prospect_success'>Success</button></td>
                    <td class='live_lost'><button class='prospect_lost'>Lost</button></td>
                </tr>
                <?php } ?>
            </tbody>
        </table>
        <button id="add_prospect_btn">Add Prospect</button>
        <div id="add_prospect_form" style="display:none;">
            <h3>Add Prospect</h3>
            <form id="add_prospect">
                <input type="text" name="name" placeholder="Name" required>
                <input type="text" name="instagram" placeholder="Instagram" required>
                <input type="email" name="email" placeholder="Email" required>
                <input type="text" name="phone" placeholder="Phone" required>
                <select name="client_type">
                    <option value="Lash Technician">Lash Technician</option>
                    <option value="Salon Owner">Salon Owner</option>
                    <option value="Salon Business">Salon Business</option>
                    <option value="Other">Other</option>
                </select>
                <select name="prospect_type">
                    <option value="Customer">Customer</option>
                    <option value="Brand Partner">Brand Partner</option>
                    <option value="Salon Partner">Salon Partner</option>
                    <option value="Other">Other</option>
                </select>
                <select name="account_manager_id">
                    <option value="0">Unassigned</option>
                    <?php
                    $users = get_users(array('role' => 'account_manager'));
                    foreach ($users as $user) {
                        echo '<option value="' . esc_html($user->ID) . '">' . esc_html($user->first_name . ' ' . $user->last_name) . '</option>';
                    }
                    ?>
                </select>
                <button type="submit">Add Prospect</button>
            </form>
        </div>
        <h2>Successful Prospects</h2>
        <div class="accordion">
            <button class="accordion-btn">Successful Prospects</button>
            <div class="accordion-content">
                <table id="successful_prospects" class="display">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Instagram</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Client Type</th>
                            <th>Prospect Type</th>
                            <th>Last Updated</th>
                            <th>Account Manager</th>
                            <th>Move to Live</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($prospects_success as $prospect) {
                            $account_manager = get_userdata($prospect->account_manager_id);
                            $account_manager_name = $account_manager ? $account_manager->first_name . ' ' . $account_manager->last_name : 'Unassigned';
                            $last_note = $wpdb->get_row($wpdb->prepare("SELECT timestamp FROM {$wpdb->prefix}prospect_notes WHERE prospect_id = %d ORDER BY timestamp DESC LIMIT 1", $prospect->id));
                            $last_updated = $last_note ? $last_note->timestamp : $prospect->last_updated;
                        ?>
                        <tr>
                            <td class='success_ID'><?php echo esc_html($prospect->id); ?></td>
                            <td class='success_name'><a href="<?php echo site_url('/admin/prospects/profile/?prospect_id=' . $prospect->id); ?>"><?php echo esc_html($prospect->name); ?></a></td>
                            <td class='success_instagram'><?php echo esc_html($prospect->instagram); ?></td>
                            <td class='success_email'><?php echo esc_html($prospect->email); ?></td>
                            <td class='success_phone'><?php echo esc_html($prospect->phone); ?></td>
                            <td class='success_client_type'><?php echo esc_html($prospect->client_type); ?></td>
                            <td class='success_prospect_type'><?php echo esc_html($prospect->prospect_type); ?></td>
                            <td class='success_last_updated'><?php echo esc_html($last_updated); ?></td>
                            <td class='success_account_manager'><?php echo esc_html($account_manager_name); ?></td>
                            <td class='success_move_to_live'><button class='button_success_to_live'>Move to live</button></td>
                        </tr>
                        <?php } ?>
                    </tbody>
                </table>
            </div>
        </div>
        <h2>Lost Prospects</h2>
        <div class="accordion">
            <button class="accordion-btn">Lost Prospects</button>
            <div class="accordion-content">
                <table id="lost_prospects" class="display">
                    <thead>
						<tr>
							<th>ID</th>
							<th>Name</th>
							<th>Instagram</th>
							<th>Email</th>
							<th>Phone</th>
							<th>Client Type</th>
							<th>Prospect Type</th>
							<th>Last Updated</th>
							<th>Reason for Loss</th>
							<th>Account Manager</th>
							<th>Reactivate</th>
						</tr>
					</thead>
                    <tbody>
                        <?php foreach ($prospects_lost as $prospect) {
                            $account_manager = get_userdata($prospect->account_manager_id);
                            $account_manager_name = $account_manager ? $account_manager->first_name . ' ' . $account_manager->last_name : 'Unassigned';
                            $last_note = $wpdb->get_row($wpdb->prepare("SELECT timestamp FROM {$wpdb->prefix}prospect_notes WHERE prospect_id = %d ORDER BY timestamp DESC LIMIT 1", $prospect->id));
                            $last_updated = $last_note ? $last_note->timestamp : $prospect->last_updated;
                        ?>
                        <tr>
                            <td class='lost_ID'><?php echo esc_html($prospect->id); ?></td>
                            <td class='lost_name'><a href="<?php echo site_url('/admin/prospects/profile/?prospect_id=' . $prospect->id); ?>"><?php echo esc_html($prospect->name); ?></a></td>
                            <td class='lost_instagram'><?php echo esc_html($prospect->instagram); ?></td>
                            <td class='lost_email'><?php echo esc_html($prospect->email); ?></td>
                            <td class='lost_phone'><?php echo esc_html($prospect->phone); ?></td>
                            <td class='lost_last_updated'><?php echo esc_html($last_updated); ?></td>
                            <td class='lost_reason'><?php echo esc_html($prospect->reason_for_loss); ?></td>
                            <td class='lost_account_manager'><?php echo esc_html($account_manager_name); ?></td>
                            <td class='lost_move_to_live'><button class='button_lost_to_live'>Move to live</button></td>
                        </tr>
                        <?php } ?>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
    jQuery(document).ready(function($) {
        $('#add_prospect_btn').on('click', function() {
            $('#add_prospect_form').show();
        });

        $('#add_prospect').on('submit', function(event) {
            event.preventDefault();
            let formData = new FormData(this);
            formData.append('action', 'add_prospect');
            formData.append('nonce', '<?php echo wp_create_nonce('add_prospect_nonce'); ?>');

            fetch('<?php echo admin_url('admin-ajax.php'); ?>', {
                method: 'POST',
                body: formData
            })
                .then(response => response.text())
                .then(data => {
                    // Add the new prospect to the table without reloading
                    $('#live_prospects').DataTable().row.add([
                        'NEW_ID', // Replace with actual ID
                        formData.get('name'),
                        formData.get('instagram'),
                        formData.get('email'),
                        formData.get('phone'),
                        formData.get('client_type'),
                        formData.get('prospect_type'),
                        'Not engaged',
                        'Cold',
                        'Just now',
                        'Unassigned',
                        '<button class="prospect_success">Success</button>',
                        '<button class="prospect_lost">Lost</button>'
                    ]).draw(false);
                    $('#add_prospect_form').hide();
                })
                .catch(error => console.error('Error:', error));
        });

        // Handle success and lost buttons
		$(document).on('click', '.prospect_success, .prospect_lost, .button_success_to_live, .button_lost_to_live', function() {
			let row = $(this).closest('tr');
			let status = $(this).hasClass('prospect_success') ? 'success' :
			$(this).hasClass('prospect_lost') ? 'lost' : 'live';
			moveProspect(row, status);
		});

        function moveProspect(row, status) {
			let formData = new FormData();
			formData.append('action', 'move_prospect');
			formData.append('id', row.find('.live_ID, .success_ID, .lost_ID').text());
			formData.append('status', status);
			formData.append('nonce', '<?php echo wp_create_nonce('move_prospect_nonce'); ?>');

			console.log(`Moving prospect with ID: ${formData.get('id')} to status: ${status}`);
			console.log(`Current columns: ${row.children('td').length}`);

			fetch('<?php echo admin_url('admin-ajax.php'); ?>', {
				method: 'POST',
				body: formData
			})
			.then(response => response.text())
			.then(data => {
				console.log('Server response:', data);
				let newRow = row.clone();
				console.log('Columns before removal:', newRow.children('td').length);

				// Ensure the number of columns matches the target table's headers
				if (status === 'success') {
					newRow.find('.live_client_type, .live_prospect_type, .live_status, .live_temperature, .live_success, .live_lost').remove();
					newRow.find('.live_last_updated').attr('class', 'success_last_updated');
					newRow.find('.live_account_manager').attr('class', 'success_account_manager');
					newRow.append('<td class="success_move_to_live"><button class="button_success_to_live">Move to live</button></td>');
					console.log('Columns after removal and addition (success):', newRow.children('td').length);
					$('#live_prospects').DataTable().row(row).remove().draw();
					$('#successful_prospects').DataTable().row.add(newRow).draw();
				} else if (status === 'lost') {
					newRow.find('.live_client_type, .live_prospect_type, .live_status, .live_temperature, .live_success, .live_lost').remove();
					newRow.find('.live_last_updated').attr('class', 'lost_last_updated');
					newRow.find('.live_account_manager').attr('class', 'lost_reason');
					newRow.append('<td class="lost_move_to_live"><button class="button_lost_to_live">Move to live</button></td>');
					console.log('Columns after removal and addition (lost):', newRow.children('td').length);
					$('#live_prospects').DataTable().row(row).remove().draw();
					$('#lost_prospects').DataTable().row.add(newRow).draw();
				} else {
					newRow.find('.success_move_to_live, .lost_reason, .lost_move_to_live').remove();
					newRow.append('<td class="live_client_type">Unassigned</td><td class="live_prospect_type">Unassigned</td><td class="live_success"><button class="prospect_success">Success</button></td><td class="live_lost"><button class="prospect_lost">Lost</button></td>');
					let table = row.closest('table').attr('id');
					console.log('Columns after removal and addition (live):', newRow.children('td').length);
					$('#'+table).DataTable().row(row).remove().draw();
					$('#live_prospects').DataTable().row.add(newRow).draw();
				}
			})
			.catch(error => console.error('Error:', error));
		}

        // Accordion functionality
        $(document).on('click', '.accordion-btn', function() {
            $(this).toggleClass('accordion-btn-active');
            let accordionContent = $(this).next('.accordion-content');
            if ($(this).hasClass('accordion-btn-active')) {
                accordionContent.css('max-height', accordionContent.prop('scrollHeight') + 'px');
            } else {
                accordionContent.css('max-height', '0');
            }
        });

        // Initialize DataTables with 100 results per page
        $('#live_prospects, #successful_prospects, #lost_prospects').DataTable({
            "pageLength": 100
        });
    });
    </script>
    <?php
    return ob_get_clean();
}
add_shortcode('prospects', 'render_prospects_shortcode');

function add_prospect() {
    if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'add_prospect_nonce')) {
        die('Invalid nonce');
    }

    $name = sanitize_text_field($_POST['name']);
    $instagram = sanitize_text_field($_POST['instagram']);
    $email = sanitize_email($_POST['email']);
    $phone = sanitize_text_field($_POST['phone']);
    $client_type = sanitize_text_field($_POST['client_type']);
    $prospect_type = sanitize_text_field($_POST['prospect_type']);
    $account_manager_id = intval($_POST['account_manager_id']);

    global $wpdb;
    $table_name = $wpdb->prefix . 'prospects';
    $wpdb->insert($table_name, [
        'name' => $name,
        'instagram' => $instagram,
        'email' => $email,
        'phone' => $phone,
        'client_type' => $client_type,
        'prospect_type' => $prospect_type,
        'status' => 'Not engaged',
        'temperature' => 'Cold',
        'last_updated' => current_time('mysql'),
        'account_manager_id' => $account_manager_id,
        'prospect_status' => 'live'
    ]);

    echo 'Prospect added successfully';
    wp_die();
}
add_action('wp_ajax_add_prospect', 'add_prospect');

function move_prospect() {
    if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'move_prospect_nonce')) {
        die('Invalid nonce');
    }

    $id = intval($_POST['id']);
    $status = sanitize_text_field($_POST['status']);

    global $wpdb;
    $table_name = $wpdb->prefix . 'prospects';
    $result = $wpdb->update(
        $table_name,
        ['prospect_status' => $status],
        ['id' => $id]
    );

    if ($result === false) {
        echo 'Error moving prospect';
    } else {
        echo 'Prospect moved successfully';
    }
    wp_die();
}
add_action('wp_ajax_move_prospect', 'move_prospect');
